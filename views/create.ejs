<!DOCTYPE html>
<html lang="en">

<%- include('layouts/header'); -%>

<body>

  

  <!-- Main Content -->
  <div id="page-wrapper">
  <div class="container">
    <div class="row-1">
      <div class="col-lg-8 col-md-10 mx-auto">
          <form action="/posts/store" method="POST"
          enctype="multipart/form-data">
          <div class="control-group">
            <div class="form-group floating-label-form-group controls">
              <label>Title</label>
              <input type="text" class="form-control" placeholder="Title" id="title" name="title">
              <p class="help-block text-danger"></p>
            </div>
          </div>
          <div class="control-group">
            <div class="form-group floating-label-form-group controls">
              <label>Desription</label>
              <textarea rows="5" class="form-control" id="body" name="body" ></textarea>              
              
            </div>
          </div>
          <div class="control-group">
              
            
            
              <div class="form-group floating-label-form-group controls">
              <label>Image</label>
              <input type="file" class="form-control" id="image"
                name="image">
              </div>
          </div>
          <br>
          <div id="success"></div>
          <button type="submit" class="btn btn-primary" id="sendMessageButton">Send</button>
        </form>
        <input type="file" id="file-input">
              <p id="status">Please select a file</p>
      </div>
    </div>
  </div>
  <div id='preview'></div>

  <hr>

  <!-- Footer -->
</div>

<script type="module">
  import exifr from '/exifr/dist/full.esm.js'
  
  function uploadFile(file, signedRequest, url){
    const xhr = new XMLHttpRequest();
    xhr.open('PUT', signedRequest);
    xhr.onreadystatechange = () => {
      if(xhr.readyState === 4){
        if(xhr.status === 200){
          console.log('success');
          window.location = "/";
        }
        else{
          alert('Could not upload file.')
        }
      }
    };
    xhr.send(file);
  }
  
  function getSignedRequest(file){
    console.log(file)
    const xhr = new XMLHttpRequest();
    xhr.open('GET', `/sign-s3?file-name=${file.name}&file-type=${file.type}`);
    xhr.onreadystatechange = () => {
      if(xhr.readyState === 4){
        if(xhr.status === 200){
          //console.log(xhr.responseText)
          const response = JSON.parse(xhr.responseText);
          console.log(response.url)
          console.log(response.signedRequest)
          //uploadFile(file, response.signedRequest, response.url);
        }
        else{
          alert('Could not get signed URL.');
        }
      }
    };
    xhr.send();
  }

  async function getExifData(file){
    console.log('this is the name of the file: ' + file.name)
    let exifData = await exifr.parse(file)
    const xhr = new XMLHttpRequest();
    xhr.open('POST', `/sendExifData?file-name=${file.name}`);  
    xhr.setRequestHeader('Content-type','application/json')
    xhr.send(JSON.stringify(exifData));
  }

  function initUpload(){
    const files = document.getElementById('file-input').files;
    const file = files[0];
    if(file == null){
      return alert('No file selected.');
    }
    
    /*
    const canvas = document.createElement('canvas');
    const img = document.createElement('img');
    img.src = window.URL.createObjectURL(file);
    console.log('This is the createObjectURL: ' + img.src)
    
    //var ctx = canvas.getContext("2d");
    
    //ctx.drawImage(img, 0, 0);
    
    var MAX_WIDTH = 800;
    var MAX_HEIGHT = 600;
    var width = img.width;
    var height = img.height;

    if (width > height) {
      if (width > MAX_WIDTH) {
        height *= MAX_WIDTH / width;
        width = MAX_WIDTH;
      }
    } else {
      if (height > MAX_HEIGHT) {
        width *= MAX_HEIGHT / height;
        height = MAX_HEIGHT;
      }
    }
    canvas.width = width;
    canvas.height = height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, width, height);
    var dataurl = canvas.toDataURL("image/png");
    canvas.toBlob(function(dataurl) {
      var newImg = document.createElement('img'),
          url = URL.createObjectURL(dataurl);
          console.log(url)

    });
    //console.log('this is resized image: ' + dataurl)
    //console.log(file)
    /*
    
    //canvas.width = img.width;
    //canvas.height = img.height;
    //canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
    //const objectURL = window.URL.createObjectURL(file);
    */
    
    //getExifData(file);
    //getSignedRequest(file);
    
  }
  
  let imgInput = document.getElementById('file-input');
  imgInput.addEventListener('change', function (e) {
      if (e.target.files) {
          let imageFile = e.target.files[0];
          var reader = new FileReader();
          reader.onload = function (e) {
              var img = document.createElement("img");
              img.onload = function (event) {
                  // Dynamically create a canvas element
                  var canvas = document.createElement("canvas");

                  // var canvas = document.getElementById("canvas");
                  var ctx = canvas.getContext("2d");

                  // Actual resizing
                  ctx.drawImage(img, 0, 0, 300, 300);

                  // Show resized image in preview element
                  var dataurl = canvas.toDataURL(imageFile.type);
                  console.log('this is the dataURL: ' + dataurl)
                  getExifData(dataurl);
                  document.getElementById("preview").src = dataurl;
              }
              img.src = e.target.result;
          }
          reader.readAsDataURL(imageFile);
      }
  });  

  (() => {
    document.getElementById('file-input').onchange = initUpload; 
      
  })();
  
</script>
<!--
<script type="module">
  import exifr from '/exifr/dist/lite.esm.js'
  document.querySelector('#image').addEventListener('change', async e => {
    let file = e.target.files[0]
    let exifData = await exifr.parse(file)
    console.log('exifData', exifData)
  })
</script>

-->
<%- include('layouts/script.ejs'); -%>



</body>

</html>
